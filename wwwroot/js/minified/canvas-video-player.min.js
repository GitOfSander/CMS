var cvpHandlers={canvasClickHandler:null,videoTimeUpdateHandler:null,videoCanPlayHandler:null,windowResizeHandler:null},CanvasVideoPlayer=function(n){var t,i;this.options={framesPerSecond:25,hideVideo:!0,autoplay:!1,makeLoop:!1,pauseOnClick:!0,audio:!1,timelineSelector:!1,resetOnLastFrame:!0};for(t in n)this.options[t]=n[t];if(this.video=document.querySelector(this.options.videoSelector),this.canvas=document.querySelector(this.options.canvasSelector),this.timeline=document.querySelector(this.options.timelineSelector),this.timelinePassed=document.querySelector(this.options.timelineSelector+"> div"),!this.options.videoSelector||!this.video){console.error('No "videoSelector" property, or the element is not found');return}if(!this.options.canvasSelector||!this.canvas){console.error('No "canvasSelector" property, or the element is not found');return}if(this.options.timelineSelector&&!this.timeline){console.error('Element for the "timelineSelector" selector not found');return}if(this.options.timelineSelector&&!this.timelinePassed){console.error('Element for the "timelinePassed" not found');return}if(this.options.audio){if(typeof this.options.audio=="string"){if(this.audio=document.querySelectorAll(this.options.audio)[0],!this.audio){console.error('Element for the "audio" not found');return}}else this.audio=document.createElement("audio"),this.audio.innerHTML=this.video.innerHTML,this.video.parentNode.insertBefore(this.audio,this.video),this.audio.load();i=/iPad|iPhone|iPod/.test(navigator.platform);i&&(this.options.autoplay=!1)}this.ctx=this.canvas.getContext("2d");this.playing=!1;this.resizeTimeoutReference=!1;this.RESIZE_TIMEOUT=1e3;this.init();this.bind()};CanvasVideoPlayer.prototype.init=function(){this.video.load();this.setCanvasSize();this.options.hideVideo&&(this.video.style.display="none")};CanvasVideoPlayer.prototype.getOffset=function(n){var i,t,r;if(n)return t=n.getBoundingClientRect(),t.width||t.height||n.getClientRects().length?(r=n.ownerDocument,i=r.documentElement,{top:t.top+window.pageYOffset-i.clientTop,left:t.left+window.pageXOffset-i.clientLeft}):void 0};CanvasVideoPlayer.prototype.jumpTo=function(n){this.video.currentTime=this.video.duration*n;this.options.audio&&(this.audio.currentTime=this.audio.duration*n)};CanvasVideoPlayer.prototype.bind=function(){var n=this;this.options.pauseOnClick===!0&&this.canvas.addEventListener("click",cvpHandlers.canvasClickHandler=function(){n.playPause()});this.video.addEventListener("timeupdate",cvpHandlers.videoTimeUpdateHandler=function(){n.drawFrame();n.options.timelineSelector&&n.updateTimeline()});this.video.addEventListener("canplay",cvpHandlers.videoCanPlayHandler=function(){n.drawFrame()});this.video.readyState>=2&&n.drawFrame();n.options.autoplay&&n.play();n.options.timelineSelector&&this.timeline.addEventListener("click",function(t){var i=t.clientX-n.getOffset(n.canvas).left,r=i/n.timeline.offsetWidth;n.jumpTo(r)});window.addEventListener("resize",cvpHandlers.windowResizeHandler=function(){clearTimeout(n.resizeTimeoutReference);n.resizeTimeoutReference=setTimeout(function(){n.setCanvasSize();n.drawFrame()},n.RESIZE_TIMEOUT)});this.unbind=function(){this.canvas.removeEventListener("click",cvpHandlers.canvasClickHandler);this.video.removeEventListener("timeupdate",cvpHandlers.videoTimeUpdateHandler);this.video.removeEventListener("canplay",cvpHandlers.videoCanPlayHandler);window.removeEventListener("resize",cvpHandlers.windowResizeHandler);this.options.audio&&this.audio.parentNode.removeChild(this.audio)}};CanvasVideoPlayer.prototype.updateTimeline=function(){var n=(this.video.currentTime*100/this.video.duration).toFixed(2);this.timelinePassed.style.width=n+"%"};CanvasVideoPlayer.prototype.setCanvasSize=function(){this.width=this.canvas.clientWidth;this.height=this.canvas.clientHeight;this.canvas.setAttribute("width",this.width);this.canvas.setAttribute("height",this.height)};CanvasVideoPlayer.prototype.play=function(){this.lastTime=Date.now();this.playing=!0;this.loop();this.options.audio&&(this.audio.currentTime=this.video.currentTime,this.audio.play())};CanvasVideoPlayer.prototype.pause=function(){this.playing=!1;this.options.audio&&this.audio.pause()};CanvasVideoPlayer.prototype.playPause=function(){this.playing?this.pause():this.play()};CanvasVideoPlayer.prototype.loop=function(){var i=this,n=Date.now(),t=(n-this.lastTime)/1e3;t>=1/this.options.framesPerSecond&&(this.video.currentTime=this.video.currentTime+t,this.lastTime=n,this.audio&&Math.abs(this.audio.currentTime-this.video.currentTime)>.3&&(this.audio.currentTime=this.video.currentTime));this.video.currentTime>=this.video.duration&&(this.options.makeLoop===!1&&(this.playing=!1),this.options.resetOnLastFrame===!0&&(this.video.currentTime=0));this.playing?this.animationFrame=requestAnimationFrame(function(){i.loop()}):cancelAnimationFrame(this.animationFrame)};CanvasVideoPlayer.prototype.drawFrame=function(){this.ctx.drawImage(this.video,0,0,this.width,this.height)};